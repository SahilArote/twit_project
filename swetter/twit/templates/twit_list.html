{% extends "layout.html" %}
{% load profile_tags %}

{% block title %}
Bolo or Suuno
{% endblock %}

{% block content %}

<style>
body {
  background-color: #000;
  font-family: 'Segoe UI', sans-serif;
}

/* Feed container */
.feed {
  max-width: 600px;
  margin: auto;
}

/* Post card */
.post-card {
  background-color: #000;
  border: 1px solid #262626;
  border-radius: 8px;
  margin-bottom: 30px;
  overflow: hidden;
  box-shadow: 0 0 5px rgba(255,255,255,0.05);
}

/* Header */
.post-header {
  padding: 10px 15px;
  font-weight: 600;
  border-bottom: 1px solid #262626;
}

/* Profile photo */
.post-header img {
  border: 2px solid #444;
}

/* Image */
.post-img {
  width: 100%;
  max-height: 450px;
  object-fit: cover;
  display: block;
}

/* Caption */
.post-body {
  padding: 10px 15px;
  color: #fff;
  font-size: 15px;
  white-space: pre-wrap;
}

/* Actions */
.post-actions {
  padding: 10px 15px;
}

.post-actions button {
  font-size: 14px;
}

.comments {
  padding: 0 15px 15px 15px;
}

.comments p {
  color: #ccc;
  font-size: 14px;
  margin-bottom: 6px;
}
</style>

<div class="feed mt-4">
  {% for twit in twits %}
    {% get_profile twit.user as twit_profile %}
    <div class="post-card">
      
      <!-- Header -->
      <div class="post-header text-white d-flex align-items-center">
        {% if twit_profile and twit_profile.profile_photo %}
          <img src="{{ twit_profile.profile_photo.url }}" alt="Profile photo" class="rounded-circle me-2" width="40" height="40">
        {% endif %}
        <a href="{% url 'user_profile' username=twit.user.username %}" class="nav-link fw-bold">
          {{ twit.user.username }}
        </a>
      </div>

      <!-- Image -->
      {% if twit.photo and twit.photo.name %}
        <img src="{{ twit.photo.url }}" class="post-img" alt="Post image">
      {% else %}
        <img src="/static/default.jpg" class="post-img" alt="Default image">
      {% endif %}

      <!-- Caption -->
      <div class="post-body">
        <p class="mb-2">{{ twit.text }}</p>
      </div>

      <!-- Actions -->
      <div class="post-actions d-flex gap-3 mt-2" data-post="{{ twit.id }}">
        <button class="btn btn-outline-light btn-sm like-btn">
          ‚ù§Ô∏è <span class="like-label">
            {% if twit.id in liked_post_ids %}Unlike{% else %}Like{% endif %}
          </span>
          (<span class="like-count">{{ twit.likes.count }}</span>)
        </button>

        <input type="text" class="form-control form-control-sm comment-input" placeholder="Add comment...">
        <button class="btn btn-outline-info btn-sm comment-btn">üí¨ Comment</button>

        <!-- ‚úÖ Receiver dropdown + Share button -->
         
        <button class="btn btn-outline-primary btn-sm share-btn">üì§ Share</button>
      </div>

      <!-- Comments -->
      <div class="comments">
        {% for comment in twit.comments.all %}
          <p><strong>{{ comment.user.username }}</strong>: {{ comment.text }}</p>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Like button
  document.querySelectorAll(".like-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const postId = btn.closest(".post-actions").dataset.post;
      fetch(`/like/${postId}/`, { 
        method: "POST", 
        headers: { "X-CSRFToken": getCookie("csrftoken") } 
      })
      .then(res => res.json())
      .then(data => {
        btn.querySelector(".like-count").textContent = data.likes_count;
        btn.querySelector(".like-label").textContent =
          data.status === "liked" ? "Unlike" : "Like";
      });
    });
  });

  // Comment button
  document.querySelectorAll(".comment-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const postActions = btn.closest(".post-actions");
      const postId = postActions.dataset.post;
      const input = postActions.querySelector(".comment-input");
      fetch(`/comment/${postId}/`, {
        method: "POST",
        headers: { 
          "X-CSRFToken": getCookie("csrftoken"), 
          "Content-Type": "application/x-www-form-urlencoded" 
        },
        body: `comment=${encodeURIComponent(input.value)}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "ok") {
          const commentsDiv = postActions.nextElementSibling;
          const newComment = document.createElement("p");
          newComment.innerHTML = `<strong>${data.user}</strong>: ${data.text}`;
          commentsDiv.appendChild(newComment);
          input.value = "";
        }
      });
    });
  });
// Share button
 document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".share-user").forEach(link => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const receiver = link.dataset.username;
      const container = link.closest(".post-actions");
      const postId = container.dataset.post;

      const chatSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/chat/" + receiver + "/"
      );

      chatSocket.onopen = () => {
        chatSocket.send(JSON.stringify({
          message: "Shared a post with you!",
          post_id: postId
        }));
        alert("Post sent to " + receiver);
      };
    });
  });
});


  // Helper: get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

{% endblock %}